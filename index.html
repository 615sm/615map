<!DOCTYPE html>
<html lang="ja">
<head>
    <title>ãƒ‡ãƒ¼ã‚¿å¾©å…ƒä¸­...</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 20px; font-family: sans-serif; text-align: center; }
        #status { font-size: 24px; font-weight: bold; margin-bottom: 10px; }
        #log { background: #eee; padding: 10px; border-radius: 5px; text-align: left; height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <div id="status">ğŸ”„ ãƒ‡ãƒ¼ã‚¿å¾©å…ƒã‚’é–‹å§‹ã—ã¾ã™...</div>
    <p id="counter">0ä»¶ ç§»è¡Œæ¸ˆã¿</p>
    <div id="log"></div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCT1QoYP3SxIOjFOrWdZWBg7akzYzcijL0",
            authDomain: "tankyuu-89580.firebaseapp.com",
            projectId: "tankyuu-89580",
            storageBucket: "tankyuu-89580.firebasestorage.app",
            messagingSenderId: "88004060927",
            appId: "1:88004060927:web:0cbb798daf727883a38eca"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const log = (msg) => { document.getElementById('log').innerHTML += msg + "<br>"; };

        async function recover() {
            // ã‚¹ã‚­ãƒ£ãƒ³ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«åãƒªã‚¹ãƒˆï¼ˆè€ƒãˆã‚‰ã‚Œã‚‹ã‚‚ã®ã‚’å…¨ã¦å…¥ã‚Œã¾ã—ãŸï¼‰
            const files = ['ã‚´ãƒŸç®±.kml', 'ãƒˆã‚¤ãƒ¬.kml', 'çµ¦æ°´å™¨.kml', 'gomibako.kml', 'toilet.kml', 'water.kml'];
            let total = 0;

            for (const file of files) {
                log(`ãƒ•ã‚¡ã‚¤ãƒ« ${file} ã‚’ç¢ºèªä¸­...`);
                try {
                    const res = await fetch(file);
                    if (!res.ok) { log(`â†’ ${file} ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`); continue; }
                    
                    const text = await res.text();
                    const kml = new DOMParser().parseFromString(text, "text/xml");
                    const placemarks = kml.getElementsByTagName("Placemark");
                    const tag = file.split('.')[0];

                    log(`â†’ ${file} ã‹ã‚‰ ${placemarks.length} ä»¶è¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚ä¿å­˜ä¸­...`);

                    for (let p of placemarks) {
                        const coords = p.querySelector("coordinates")?.textContent.trim().split(",");
                        if (coords) {
                            await db.collection("bins").add({
                                lat: parseFloat(coords[1]),
                                lng: parseFloat(coords[0]),
                                name: p.querySelector("name")?.textContent || "ç„¡é¡Œ",
                                memo: p.querySelector("description")?.textContent || "",
                                tag: tag
                            });
                            total++;
                            document.getElementById('counter').innerText = `${total}ä»¶ ç§»è¡Œå®Œäº†`;
                        }
                    }
                } catch (e) { log(`âŒ ã‚¨ãƒ©ãƒ¼: ${e.message}`); }
            }
            document.getElementById('status').innerText = "âœ… å¾©å…ƒå®Œäº†ï¼";
            document.getElementById('status').style.color = "green";
            log("<b>ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’Firebaseã«ä¿å­˜ã—ã¾ã—ãŸã€‚ä»¥å‰ã®ã€å®Œå…¨ç‰ˆã‚³ãƒ¼ãƒ‰ã€ã«æˆ»ã—ã¦ãã ã•ã„ã€‚</b>");
        }
        recover();
    </script>
</body>
</html>
