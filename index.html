<!DOCTYPE html>
<html lang="ja">
<head>
    <title>615ãƒãƒƒãƒ—</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; }
        #map { height: 100vh; width: 100%; position: absolute; z-index: 1; }
        .ui-panel { position: absolute; top: 10px; left: 10px; z-index: 1000; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); width: 220px; font-family: sans-serif; }
        input, select, button { width: 100%; margin-bottom: 5px; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        button { background: #2196F3; color: white; border: none; font-weight: bold; cursor: pointer; }
        .dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
    </style>
</head>
<body>
    <div class="ui-panel">
        <input type="text" id="address" placeholder="åº—åãƒ»ä½æ‰€ã‚’æ¤œç´¢">
        <button onclick="searchAddr()">æ¤œç´¢</button>
        <hr>
        <select id="tag-filter" onchange="renderPins()">
            <option value="ã™ã¹ã¦">ã™ã¹ã¦è¡¨ç¤º</option>
            <option value="ã‚´ãƒŸç®±">ã‚´ãƒŸç®±ã®ã¿</option>
            <option value="ãƒˆã‚¤ãƒ¬">ãƒˆã‚¤ãƒ¬ã®ã¿</option>
            <option value="çµ¦æ°´å™¨">çµ¦æ°´å™¨ã®ã¿</option>
        </select>
        <button onclick="locateUser()" style="background:#4CAF50;">ğŸ“ ç¾åœ¨åœ°ã‚’è¡¨ç¤º</button>
        <div style="font-size:12px; margin-top:5px;">
            <span class="dot" style="background:#FF5252;"></span>ã‚´ãƒŸç®± 
            <span class="dot" style="background:#448AFF;"></span>ãƒˆã‚¤ãƒ¬ 
            <span class="dot" style="background:#4CAF50;"></span>çµ¦æ°´
        </div>
    </div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCT1QoYP3SxIOjFOrWdZWBg7akzYzcijL0",
            authDomain: "tankyuu-89580.firebaseapp.com",
            projectId: "tankyuu-89580",
            storageBucket: "tankyuu-89580.firebasestorage.app",
            messagingSenderId: "88004060927",
            appId: "1:88004060927:web:0cbb798daf727883a38eca"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const map = L.map('map').setView([35.676, 139.765], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        const layerGroup = L.layerGroup().addTo(map);
        let pins = [];

        db.collection("bins").onSnapshot(snap => {
            pins = snap.docs.map(doc => ({id: doc.id, ...doc.data()}));
            renderPins();
        });

        function renderPins() {
            layerGroup.clearLayers();
            const filter = document.getElementById('tag-filter').value;
            pins.forEach(d => {
                if (filter !== "ã™ã¹ã¦" && !d.tag.includes(filter)) return;
                const color = d.tag.includes("ã‚´ãƒŸ") ? "#FF5252" : d.tag.includes("ãƒˆã‚¤ãƒ¬") ? "#448AFF" : "#4CAF50";
                const icon = L.divIcon({ html: `<div style="background:${color};width:12px;height:12px;border-radius:50%;border:2px solid white;"></div>`, className: '' });
                L.marker([d.lat, d.lng], {icon}).addTo(layerGroup).bindPopup(`<b>${d.name}</b><br>${d.memo}`);
            });
        }

        // --- æ”¹è‰¯ç‰ˆï¼šæ–½è¨­åæ¤œç´¢ ---
        window.searchAddr = () => {
            const q = document.getElementById('address').value;
            if (!q) return;
            // Nominatimã¨ã„ã†ç„¡æ–™æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã‚’ä½¿ç”¨ã€‚æ—¥æœ¬èªã‚„æ–½è¨­åã«å¯¾å¿œã€‚
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&accept-language=ja`)
            .then(r => r.json())
            .then(d => {
                if (d && d.length > 0) {
                    // æœ€ã‚‚ç¢ºåº¦ã®é«˜ã„æ¤œç´¢çµæœã«ã‚¸ãƒ£ãƒ³ãƒ—
                    map.setView([d[0].lat, d[0].lon], 17);
                    // æ¤œç´¢ã—ãŸå ´æ‰€ã«èµ¤ã„ä¸€æ™‚çš„ãªãƒãƒ¼ã‚«ãƒ¼ã‚’ç«‹ã¦ã‚‹
                    L.popup()
                        .setLatLng([d[0].lat, d[0].lon])
                        .setContent(`æ¤œç´¢çµæœ: ${q}`)
                        .openOn(map);
                } else {
                    alert("è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚åˆ¥ã®è¨€è‘‰ã§è©¦ã—ã¦ã¿ã¦ãã ã•ã„ã€‚");
                }
            })
            .catch(e => alert("æ¤œç´¢ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚"));
        };

        // --- ç¾åœ¨åœ°è¡¨ç¤º ---
        window.locateUser = () => {
            map.locate({setView: true, maxZoom: 16});
        };
        map.on('locationfound', e => {
            L.circleMarker(e.latlng, {radius: 8, color: '#2196F3', fillColor: '#2196F3', fillOpacity: 0.8}).addTo(map).bindPopup("ç¾åœ¨åœ°").openPopup();
        });
        map.on('locationerror', () => alert("ä½ç½®æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚"));

        // æ–°è¦è¿½åŠ 
        map.on('click', async e => {
            const name = prompt("åœ°ç‚¹åã‚’å…¥åŠ›"); if(!name) return;
            const tag = prompt("ã‚¿ã‚°(ã‚´ãƒŸç®±/ãƒˆã‚¤ãƒ¬/çµ¦æ°´å™¨)", "çµ¦æ°´å™¨");
            await db.collection("bins").add({ lat: e.latlng.lat, lng: e.latlng.lng, name, tag, memo: "" });
        });
    </script>
</body>
</html>
