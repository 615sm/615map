<!DOCTYPE html>
<html lang="ja">
<head>
    <title>615マップ（データ復旧中...）</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; }
        #map { height: 100vh; width: 100%; }
        .ui-panel { position: absolute; top: 10px; left: 10px; z-index: 1000; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .status { color: #f44336; font-weight: bold; }
    </style>
</head>
<body>

<div class="ui-panel">
    <h3>データ復旧・移行パネル</h3>
    <div id="status" class="status">準備中...</div>
    <p id="counter">読み込みをお待ちください</p>
</div>

<div id="map"></div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCT1QoYP3SxIOjFOrWdZWBg7akzYzcijL0",
        authDomain: "tankyuu-89580.firebaseapp.com",
        projectId: "tankyuu-89580",
        storageBucket: "tankyuu-89580.firebasestorage.app",
        messagingSenderId: "88004060927",
        appId: "1:88004060927:web:0cbb798daf727883a38eca"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const map = L.map('map').setView([35.676, 139.765], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    async function startImport() {
        const statusEl = document.getElementById('status');
        const counterEl = document.getElementById('counter');
        
        // GitHubにあるKMLファイルを自動スキャン（名前が違う場合はここを修正してください）
        const files = ['ゴミ箱.kml', 'トイレ.kml', '給水器.kml', 'gomibako.kml', 'toilet.kml', 'kyusuiki.kml'];
        let total = 0;

        statusEl.innerText = "KMLをスキャンしてFirebaseに書き込んでいます...";

        for (const file of files) {
            try {
                const res = await fetch(file);
                if (!res.ok) continue;
                const text = await res.text();
                const kml = new DOMParser().parseFromString(text, "text/xml");
                const placemarks = kml.getElementsByTagName("Placemark");
                const tag = file.split('.')[0]; 

                for (let p of placemarks) {
                    const coords = p.querySelector("coordinates")?.textContent.trim().split(",");
                    if (coords) {
                        await db.collection("bins").add({
                            lat: parseFloat(coords[1]),
                            lng: parseFloat(coords[0]),
                            name: p.querySelector("name")?.textContent || "無題",
                            memo: p.querySelector("description")?.textContent || "",
                            tag: tag
                        });
                        total++;
                        counterEl.innerText = `${total}件 移行完了...`;
                    }
                }
            } catch (e) { console.error(e); }
        }

        statusEl.style.color = "green";
        statusEl.innerText = "復旧完了！";
        alert(`${total}件のデータをFirebaseに保存しました。もうこのコードは不要です。`);
    }

    startImport();
</script>
</body>
</html>
